<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <th:block th:replace="~{_common/header.html :: configFragment}"></th:block>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>선다형평가</title>
    <link rel="stylesheet" href="/css/exam/one.css">
</head>
<body>
<th:block th:replace="~{_common/header.html :: studentHeader}"></th:block>
<main>
    <div class="title-container">
        <div class="title-item1">
            <button type="button" class="btn btn-secondary" onclick="location.href='/users/list'" style="display: none;">
                prev
            </button>
        </div>
        <div class="title-item2">
            <h1>선다형평가</h1>
        </div>
        <div class="title-item3">
            <button type="button" class="btn btn-warning btn-sm" onclick="location.href='/students/one'" style="display: none;">
                정보수정
            </button>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col">
                <table class="table table-bordered one-table">
                    <tbody>
                    <tr>
                        <td>교과목명</td>
                        <td th:text="${examDetails.examPapers.name}"></td>
                    </tr>
                    <tr>
                        <td>능력단위</td>
                        <td th:text="${examDetails.examPapers.getAbilityUnitName()}"></td>
                    </tr>
                    <tr>
                        <td>평가방법</td>
                        <td th:text="${examDetails.examPapers.getExamType()}"></td>
                    </tr>
                    </tbody>
                </table>

                <table class="table table-bordered one-table">
                    <tbody>
                    <tr>
                        <td>이름</td>
                        <td th:text="${examDetails.students.name}"></td>
                    </tr>
                    <tr>
                        <td>연락처</td>
                        <td th:text="${examDetails.students.tel}"></td>
                    </tr>
                    </tbody>
                </table>

                <table class="table table-bordered custom-table">
                    <thead>
                    <tr>
                        <th>번호</th>
                        <th>질문</th>
                        <th>답변</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="question : ${questions}">
                        <td th:text="${question.no}"></td>
                        <td th:text="${question.content} + ' (배점 ' + ${question.point} + '점)'" class="question-point"></td>
                        <td>
                            <table>
                                <tbody>
                                <tr th:each="answer : ${answers}">
                                    <td th:if="${answer.examPaperMultipleQuestion.id == question.id}">
                                        <input type="radio" th:id="'option' + ${answer.no}" th:name="'version_control_' + ${question.no}" th:value="${answer.id}">
                                        <label th:for="'option' + ${answer.no}" th:text="${answer.content}"></label>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="title-item2">
        <!-- th:attr을 사용하여 data-exams-id 속성을 설정 -->
        <form id="saveForm" th:attr="data-exams-id=${examDetails.id}">
            <button type="button" class="btn btn-primary" onclick="submitExam()">
                제출
            </button>
        </form>
    </div>
</main>

<script>
    function submitExam() {
        const form = document.getElementById('saveForm');
        const examsId = form.getAttribute('data-exams-id'); // 시험 ID 가져오기

        // examId가 제대로 설정되어 있는지 확인
        console.log('시험 ID:', examsId);

        const selectedAnswers = {};
        document.querySelectorAll('input[type="radio"]:checked').forEach(input => {
            const questionId = input.name.split('_').pop();
            selectedAnswers[questionId] = input.value;
        });

        fetch(`/api/v1/exams/result/${examsId}`, { // 시험 ID를 URL에 포함
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // 'Authorization': 'Bearer YOUR_ACCESS_TOKEN' // 적절한 토큰으로 대체
            },
            body: JSON.stringify({
                selectedAnswers: selectedAnswers
            })
        }).then(response => response.json())
            .then(data => {
                alert('제출이 완료되었습니다.');
                saveExamItems(examsId, selectedAnswers);
            }).catch(error => {
            alert('제출 중 오류가 발생했습니다.');
            console.error('Error:', error);
        });
    }

    function saveExamItems(examsId, selectedAnswers) {
        const items = Object.keys(selectedAnswers).map(questionId => {
            const pointElement = document.querySelector(`[name="version_control_${questionId}"]:checked`).closest('tr').querySelector('.question-point');
            const pointText = pointElement ? pointElement.innerText : '0';
            const point = parseInt(pointText.replace(/\D/g, ''), 10); // 숫자만 추출하여 정수로 변환

            return {
                resultId: examsId,
                questionId: questionId,
                answerId: selectedAnswers[questionId],
                comment: "자동 생성평가 내용"
            };
        });

        items.forEach(item => {
            fetch('/api/v1/exams/result/item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'Authorization': 'Bearer YOUR_ACCESS_TOKEN' // 적절한 토큰으로 대체
                },
                body: JSON.stringify(item)
            }).then(response => response.json())
                .then(data => {
                    console.log('개별 항목 저장 완료:', data);
                }).catch(error => {
                console.error('개별 항목 저장 중 오류 발생:', error);
            });
        });
    }
</script>
</body>
</html>